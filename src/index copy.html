<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>aframe-immersive-360-urban-night</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <script>
      window.addEventListener("DOMContentLoaded", function () {
        const rig = document.querySelector("#rig");

        const human1 = document.querySelector("#human1");
        const lampLeft = document.querySelector("#lamp-left");
        const lampRight = document.querySelector("#lamp-right");

        const panel = document.querySelector("#ui-panel");
        const panelText = document.querySelector("#ui-text");

        // progresso simples
        const state = {
          visitedLeft: false,
          visitedRight: false,
        };

        function showMessage(msg) {
          panel.setAttribute("visible", true);
          panelText.setAttribute("text", "value", msg);
        }

        function teleport(x, z) {
          const pos = rig.getAttribute("position");
          rig.setAttribute("position", { x: x, y: pos.y, z: z });
        }

        function checkEnding() {
          if (state.visitedLeft && state.visitedRight) {
            showMessage(
              "Mensagem revelada ✅\n\n" +
                "As duas pistas completam-se.\n" +
                "A praça guarda segredos —\n" +
                "mas só se explorares os dois lados."
            );
          } else {
            showMessage(
              "Explora a praça:\n\n" +
                "- Clica no candeeiro da ESQ para a 1ª pista\n" +
                "- Clica no candeeiro da DIR para a 2ª pista\n\n" +
                "Depois volta aqui (centro)."
            );
          }
        }

        // START: mensagem inicial
        showMessage(
          "Bem-vindo.\n\n" +
            "Esta praça tem uma mensagem escondida.\n" +
            "Clica nos candeeiros para explorar.\n" +
            "Volta ao centro no fim."
        );

        // CLICK CENTER HUMAN = voltar ao centro + check final
        human1.addEventListener("click", function () {
          teleport(0, 0);
          checkEnding();
        });

        // LEFT LAMP = teleport + mark + show clue
        lampLeft.addEventListener("click", function () {
          teleport(-4, 0);
          state.visitedLeft = true;

          showMessage(
            "Pista 1 (Esquerda)\n\n" +
              "Repara como a luz aquece a pedra.\n" +
              "A mensagem não está no céu...\n" +
              "está no que reflete."
          );
        });

        // RIGHT LAMP = teleport + mark + show clue
        lampRight.addEventListener("click", function () {
          teleport(4, 0);
          state.visitedRight = true;

          showMessage(
            "Pista 2 (Direita)\n\n" +
              "A praça parece vazia,\n" +
              "mas está cheia de presença.\n" +
              "Procura o centro para juntar tudo."
          );
        });
      });
    </script>
  </head>

  <body style="margin: 0; overflow: hidden">
    <a-scene background="color: #000">
      <!-- 360 img -->
      <a-assets>
        <img id="foto360" src="assets/360.jpg" crossorigin="anonymous" />
        <a-asset-item
          id="lampModel"
          src="assets/central_park_lamppost.glb"
        ></a-asset-item>
      </a-assets>

      <!-- 360 -->
      <a-sky src="#foto360" rotation="0 -90 0"></a-sky>

      <!-- rig + camera (altura correta) -->
      <a-entity id="rig" position="0 1.6 0" scale="1 1 1">
        <a-camera
          wasd-controls-enabled="false"
          look-controls="pointerLockEnabled: true"
          fov="70"
        >
          <a-cursor
            raycaster="objects: .clickable"
            fuse="false"
            material="color: white; shader: flat"
            geometry="primitive: ring; radiusInner: 0.012; radiusOuter: 0.018"
          ></a-cursor>
        </a-camera>
      </a-entity>

      <!-- luz ambiente -->
      <a-entity light="type: ambient; intensity: 0.45"></a-entity>

      <!-- UI panel (simples, sempre no mesmo sítio) -->
      <a-entity
        id="ui-panel"
        visible="true"
        position="0 1.15 -1.9"
        geometry="primitive: plane; width: 2.3; height: 1.05"
        material="color:#0e0e0e; opacity:0.75; transparent:true"
      >
        <a-entity
          id="ui-text"
          position="0 0.35 0.01"
          text="value: ; align:center; width:2.2; color:#fff; baseline:top; wrapCount:34;"
        ></a-entity>
        <a-entity
          position="0 -0.43 0.01"
          text="value: (clica nos objetos para explorar); align:center; width:2.2; color:#aaa;"
        ></a-entity>
      </a-entity>

      <!-- PERSON 1 (CENTRO / HUB) -->
      <a-entity
        id="human1"
        class="clickable"
        position="0 0 -3"
        rotation="0 0 0"
        scale="1 1 1"
      >
        <!-- body (cores normais) -->
        <a-box
          position="0 1.72 0"
          width="0.28"
          height="0.28"
          depth="0.28"
          color="#d8b08c"
        ></a-box>
        <a-box
          position="0 1.25 0"
          width="0.50"
          height="0.52"
          depth="0.26"
          color="#6b6f76"
        ></a-box>
        <a-box
          position="0 0.93 0"
          width="0.46"
          height="0.18"
          depth="0.24"
          color="#2b3a67"
        ></a-box>
        <a-box
          position="-0.12 0.50 0"
          width="0.18"
          height="0.80"
          depth="0.18"
          color="#2b3a67"
        ></a-box>
        <a-box
          position="0.12 0.50 0"
          width="0.18"
          height="0.80"
          depth="0.18"
          color="#2b3a67"
        ></a-box>
        <a-box
          position="0 1.83 -0.02"
          width="0.30"
          height="0.12"
          depth="0.30"
          color="#2a1f1a"
        ></a-box>
      </a-entity>

      <!-- HOTSPOT LEFT -->
      <a-entity
        id="lamp-left"
        class="clickable"
        gltf-model="#lampModel"
        position="-4 0 3"
        rotation="0 155 0"
        scale="1 1 1"
      >
        <a-entity
          light="type: point; intensity: 1.2; distance: 10; decay: 2"
          position="0 3.2 0"
        ></a-entity>
      </a-entity>

      <!-- HOTSPOT RIGHT -->
      <a-entity
        id="lamp-right"
        class="clickable"
        gltf-model="#lampModel"
        position="4 0 3"
        rotation="0 205 0"
        scale="1 1 1"
      >
        <a-entity
          light="type: point; intensity: 1.2; distance: 10; decay: 2"
          position="0 3.2 0"
        ></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
